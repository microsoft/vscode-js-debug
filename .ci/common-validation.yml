parameters:
  runTests: true

steps:
- task: NodeTool@0
  displayName: Use Node
  inputs:
    versionSpec: 12.13.0
    checkLatest: true

- bash: |
    /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    echo ">>> Started xvfb"
  displayName: Start xvfb
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

- task: Npm@1
  displayName: npm install
  inputs:
    verbose: false

- task: Gulp@0
  displayName: gulp compile
  inputs:
    targets: compile
    publishJUnitResults: true

- task: Npm@1
  displayName: npm test
  inputs:
    command: custom
    verbose: false
    customCommand: test
  timeoutInMinutes: 10
  condition: and(eq(${{ parameters.runTests }}, true), ne(variables['Agent.OS'], 'Darwin'))
  env:
    DISPLAY: ':99.0'

- task: PublishTestResults@2
  displayName: Publish Tests Results
  inputs:
    testResultsFiles: '*-results.xml'
    searchFolder: '$(Build.ArtifactStagingDirectory)/test-results'
  condition: and(succeededOrFailed(), eq(${{ parameters.runTests }}, true))

- task: Gulp@0
  displayName: gulp lint
  inputs:
    targets: lint
